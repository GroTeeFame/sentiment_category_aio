{% extends 'base.html' %}
{% block head %}
<title>{{title}}</title>

<!-- Bootstrap CSS -->
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<!-- Bootstrap JS -->
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<!-- Datepicker CSS -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css" rel="stylesheet">
<!-- Datepicker JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>

{% endblock head %}
{% block body %}
    <div class="db-controller-wrp">
        <div class="date-container">
            <form class="date-form" action="/submit-dates" method="post">
                <div class="form-group">
                    <label class="date-label" for="startDate">Дата від:</label>
                    <input type="text" id="startDate" name="startDate" class="form-control" autocomplete="off" required>
                </div>
                <div class="form-group">
                    <label class="date-label" for="endDate">Дата до:</label>
                    <input type="text" id="endDate" name="endDate" class="form-control" autocomplete="off" required>
                </div>
                <div class="center">
                    <button type="submit" id="date-btn-db-controller" class="date-btn">Обрати</button>
                </div>
                <!-- <button type="submit" class="btn btn-primary">Обрати</button> -->
            </form>
        </div>
        <!-- <div id="pagination-controls" class="text-center mt-4"></div> -->

        <div id="documents-list" class="documents-list"></div>
        <div id="pagination-controls" class="pagination-controls"></div>
        <!-- <div id="pagination-controls" class="text-center mt-4"></div> -->

        <!-- <div class="document-full-info"></div> -->


    </div>



<script>
    $(document).ready(function(){
        $('#startDate').datepicker({
            format: 'dd-mm-yyyy',
            autoclose: true,
            todayHighlight: true,
            clearBtn: true,
        });

        $('#endDate').datepicker({
            format: 'dd-mm-yyyy',
            autoclose: true,
            todayHighlight: true,
            clearBtn: true,
        });


        $('.date-form').on('submit', function(event) {
            event.preventDefault(); // Prevent the default form submission

            var startDate = $('#startDate').val();
            var endDate = $('#endDate').val();

            document.getElementById('loading').style.display = 'grid';

            $.ajax({
                type: 'POST',
                url: '/submit-dates-dbc',
                data: {startDate: startDate, endDate: endDate},
                success: function(response) {

                    document.getElementById('loading').style.display = 'none';

                    // $('#updated-info-container').html(response); // Update the specific div with the new data
                    $('#documents-list').html(response); // Update the specific div with the new data
                    const pageData = $('#documents-list').find('#page-data').data();
                    if (pageData) {
                        renderPagination(pageData.page, pageData.totalPages);
                    }
                },
                error: function() {
                    alert('There was an error processing your request.');
                }
            });
        });
    });

    function renderPagination(currentPage, totalPages) {
        console.log("inside renderPagination() in js");

        let html = '';

        if (totalPages <= 1) {
            $('#pagination-controls').html('');
            return;
        }

        const maxVisible = 5;
        const half = Math.floor(maxVisible / 2);
        let start = Math.max(1, currentPage - half);
        let end = Math.min(totalPages, start + maxVisible - 1);

        if (end - start < maxVisible - 1) {
            start = Math.max(1, end - maxVisible + 1);
        }

        if (start > 1) {
            html += `<button class="nav-btn nav-btn-outline-primary " onclick="loadPage(1)">1</button>`;
            if (start > 2) html += `<span class="space-span">...</span>`;
        }

        for (let i = start; i <= end; i++) {
            html += `<button class="nav-btn ${i === currentPage ? 'nav-btn-primary' : 'nav-btn-outline-primary'} " onclick="loadPage(${i})">${i}</button>`;
        }

        if (end < totalPages) {
            if (end < totalPages - 1) html += `<span class="space-span">...</span>`;
            html += `<button class="nav-btn nav-btn-outline-primary " onclick="loadPage(${totalPages})">${totalPages}</button>`;
        }

        html += `
        <div class="nav-input-wrp">
            <span class="nav-span">Перейти до сторінки:</span>
            <input type="number" id="go-to-page-input" min="1" max="${totalPages}" value="${currentPage}" class="nav-input" style="width: 60px;">
            <button class="nav-btn nav-btn-secondary" onclick="goToPage(${totalPages})">Перейти</button>
        </div>
        `;

        $('#pagination-controls').html(html);
    }

    function goToPage(totalPages) {
        const input = document.getElementById('go-to-page-input');
        let page = parseInt(input.value);
        if (!isNaN(page) && page >= 1 && page <= totalPages) {
            loadPage(page);
        } else {
            alert('Введіть коректний номер сторінки від 1 до ' + totalPages);
        }
    }

    function loadPage(page) {
        const startDate = $('#startDate').val();
        const endDate = $('#endDate').val();

        document.getElementById('loading').style.display = 'grid';

        $.ajax({
            type: 'POST',
            url: '/submit-dates-dbc',
            data: {
                startDate: startDate,
                endDate: endDate,
                page: page,
                limit: 50 // number of documents per page
            },
            success: function(response) {
                document.getElementById('loading').style.display = 'none';
                $('#documents-list').html(response);

                const pageData = $('#documents-list').find('#page-data').data();
                if (pageData) {
                    renderPagination(pageData.page, pageData.totalPages);
                }
            },
            error: function() {
                alert('There was an error loading the page.');
            }
        });
    }
</script>


{% endblock body %}